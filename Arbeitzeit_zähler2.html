<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatische Arbeitszeiterfassung</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .status-card {
            padding: 30px;
            text-align: center;
            background: var(--light);
            margin: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--secondary);
        }
        
        .status-working {
            border-left-color: var(--success);
            background: #e8f6f3;
        }
        
        .status-off {
            border-left-color: var(--accent);
            background: #fdedec;
        }
        
        .time-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 20px 0;
            color: var(--primary);
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }
        
        @media (max-width: 600px) {
            .button-group {
                grid-template-columns: 1fr;
            }
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: var(--success);
            color: white;
        }
        
        .btn-stop {
            background: var(--accent);
            color: white;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .history-section {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: var(--primary);
            color: white;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 600px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .info-box {
            background: #e8f4fc;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin: 20px;
            border-radius: 0 4px 4px 0;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: var(--light);
            color: var(--dark);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Automatische Arbeitszeiterfassung</h1>
            <p>Start bei der Ankunft - Bestätigung bei Feierabend</p>
        </header>
        
        <div class="status-card" id="statusCard">
            <h2>Aktueller Status</h2>
            <div class="time-display" id="currentTime">--:--:--</div>
            <p id="statusText">Bereit zum Start der Arbeitszeit</p>
        </div>
        
        <div class="button-group">
            <button class="btn-start" id="startBtn">Arbeit starten</button>
            <button class="btn-stop" id="stopBtn" disabled>Feierabend</button>
        </div>
        
        <div class="info-box">
            <p><strong>Info:</strong> Die Arbeitszeit startet automatisch beim Klick auf "Arbeit starten" und läuft bis zur Bestätigung von "Feierabend". Alle Daten werden lokal in Ihrem Browser gespeichert.</p>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Heutige Arbeitszeit</h3>
                <div class="value" id="todayHours">0 h</div>
            </div>
            <div class="summary-card">
                <h3>Wöchentliche Gesamtzeit</h3>
                <div class="value" id="weekHours">0 h</div>
            </div>
            <div class="summary-card">
                <h3>Monatliche Gesamtzeit</h3>
                <div class="value" id="monthHours">0 h</div>
            </div>
            <div class="summary-card">
                <h3>Monatliches Ziel</h3>
                <div class="value" id="monthTarget">0 h</div>
            </div>
        </div>

        <div class="info-box" id="targetSettings">
            <h3>Ziel-Einstellungen</h3>
            <p>Wähle, wie das Monatsziel berechnet werden soll:</p>
            <label for="targetMethod">Methode:</label>
            <select id="targetMethod">
                <option value="werktage">Werktage × Tagesstunden (Standard)</option>
                <option value="wochenformel">Wochenformel (z.B. 40 × 13 / 3)</option>
            </select>
            <div style="margin-top:8px;">
                <label for="weeklyHours">Wochenstunden (für Wochenformel):</label>
                <input type="number" id="weeklyHours" value="40" step="0.5" min="0" />
            </div>
            <p style="margin-top:8px; font-size:0.9rem; color:var(--dark);">Hinweis: Standard-Tagesarbeitszeit ist <strong>8 h</strong>. Pause (automatisch) beträgt <strong>45 min</strong>.</p>
        </div>
        
        <div class="history-section">
            <h2>Arbeitshistorie</h2>
            <table>
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Startzeit</th>
                        <th>Endzeit</th>
                        <th>Arbeitszeit</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Wird durch JavaScript gefüllt -->
                </tbody>
            </table>
        </div>

        <div class="history-section">
            <h2>Manuellen Eintrag hinzufügen</h2>
            <p>Wenn du nicht mit Start/Stop arbeitest, kannst du hier Tage eintragen; die Monatsanzeige startet so automatisch bei 0.</p>
            <label for="entryDate">Datum:</label>
            <input type="date" id="entryDate" />
            <label for="entryHours">Geleistete Stunden (Dezimal, z.B. 8.25):</label>
            <input type="number" id="entryHours" step="0.01" min="0" />
            <label for="entryBreak">Pause (Minuten, optional):</label>
            <input type="number" id="entryBreak" step="1" min="0" />
            <button id="addEntryBtn">Eintrag speichern</button>
        </div>
        
        <footer>
            <p>Automatische Arbeitszeiterfassung &copy; 2023 - Funktioniert auf allen Geräten</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const currentTime = document.getElementById('currentTime');
            const statusText = document.getElementById('statusText');
            const statusCard = document.getElementById('statusCard');
            const todayHours = document.getElementById('todayHours');
            const weekHours = document.getElementById('weekHours');
            const monthHours = document.getElementById('monthHours');
            const monthTarget = document.getElementById('monthTarget');
            const targetMethodSelect = document.getElementById('targetMethod');
            const weeklyHoursInput = document.getElementById('weeklyHours');
            const historyBody = document.getElementById('historyBody');
            const addEntryBtn = document.getElementById('addEntryBtn');
            const entryDate = document.getElementById('entryDate');
            const entryHours = document.getElementById('entryHours');
            const entryBreak = document.getElementById('entryBreak');

            // Konfiguration (vernünftige Voreinstellungen)
            const dailyWorkHours = 8; // erwartet geleistete Stunden pro Arbeitstag
            const defaultBreakMinutes = 45; // Pause (Anzeige / Info)

            // Persistierte Einstellungen
            const savedTargetMethod = localStorage.getItem('targetMethod') || 'werktage';
            const savedWeeklyHours = parseFloat(localStorage.getItem('weeklyHours')) || 40;

            // UI initialisieren mit gespeicherten Werten
            targetMethodSelect.value = savedTargetMethod;
            weeklyHoursInput.value = savedWeeklyHours;

            let workInterval;
            let workStartTime = null;
            let isWorking = false;

            // Daten aus localStorage laden
            let workHistory = JSON.parse(localStorage.getItem('workHistory')) || [];

            // Aktuelle Zeit anzeigen
            function updateCurrentTime() {
                const now = new Date();
                currentTime.textContent = now.toLocaleTimeString('de-DE');
            }

            // Hilfsfunktionen
            function formatDateToDE(date) {
                const d = date.getDate().toString().padStart(2, '0');
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const y = date.getFullYear();
                return `${d}.${m}.${y}`;
            }

            function parseDEDateString(ddmmyyyy) {
                // erwartet format dd.mm.yyyy
                const parts = ddmmyyyy.split('.');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }

            function countWeekdaysInMonth(year, monthZeroBased) {
                let count = 0;
                const daysInMonth = new Date(year, monthZeroBased + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const day = new Date(year, monthZeroBased, d).getDay();
                    // day 0 = Sonntag, 6 = Samstag -> Werktage 1..5
                    if (day >= 1 && day <= 5) count++;
                }
                return count;
            }

            // Timer für Arbeitszeit
            function startWorkTimer() {
                workStartTime = new Date();
                isWorking = true;

                // Persistenz
                localStorage.setItem('activeWork', workStartTime.toISOString());

                // Status aktualisieren
                statusText.textContent = `Arbeitszeit gestartet um ${workStartTime.toLocaleTimeString('de-DE')}`;
                statusCard.classList.remove('status-off');
                statusCard.classList.add('status-working');

                // Buttons aktualisieren
                startBtn.disabled = true;
                stopBtn.disabled = false;

                // Intervall für Echtzeit-Anzeige
                workInterval = setInterval(updateWorkTime, 1000);

                // Heutige und wöchentliche Zeiten aktualisieren
                updateSummary();
            }

            function stopWorkTimer() {
                if (!workStartTime) return;

                const workEndTime = new Date();
                const rawHours = (workEndTime - workStartTime) / (1000 * 60 * 60); // Stunden

                // Automatisch Pause abziehen (defaultBreakMinutes)
                const durationHours = Math.max(0, rawHours - (defaultBreakMinutes / 60));

                // Arbeitsdaten speichern
                const workRecord = {
                    date: formatDateToDE(workStartTime),
                    startTime: workStartTime.toLocaleTimeString('de-DE'),
                    endTime: workEndTime.toLocaleTimeString('de-DE'),
                    duration: durationHours.toFixed(2)
                };

                workHistory.push(workRecord);
                localStorage.setItem('workHistory', JSON.stringify(workHistory));

                // Persistenz aufräumen
                localStorage.removeItem('activeWork');

                // Status zurücksetzen
                isWorking = false;
                clearInterval(workInterval);

                // Status aktualisieren
                statusText.textContent = `Feierabend! Gearbeitet: ${durationHours.toFixed(2)} Stunden (Pause ${defaultBreakMinutes} min abgezogen)`;
                statusCard.classList.remove('status-working');
                statusCard.classList.add('status-off');

                // Buttons aktualisieren
                startBtn.disabled = false;
                stopBtn.disabled = true;

                // Historie und Zusammenfassung aktualisieren
                updateHistory();
                updateSummary();
            }

            function updateWorkTime() {
                // Live-Anzeige heutige Zeit: Summe gespeicherter Heute-Einträge plus laufende Zeit
                const now = new Date();
                let ongoing = 0;
                if (isWorking && workStartTime) {
                    const raw = (now - workStartTime) / (1000 * 60 * 60);
                    // Live: zeige bereits abgezogene Pause (nicht negativ)
                    ongoing = Math.max(0, raw - (defaultBreakMinutes / 60));
                }

                const today = new Date().toLocaleDateString('de-DE');
                const todayRecords = workHistory.filter(record => record.date === today);
                const todayTotal = todayRecords.reduce((sum, record) => sum + parseFloat(record.duration), 0);

                const total = todayTotal + ongoing;
                todayHours.textContent = total.toFixed(2) + ' h';
            }

            function updateSummary() {
                // Heutige Arbeitszeit berechnen (inkl. gespeicherter Einträge)
                const today = new Date().toLocaleDateString('de-DE');
                const todayRecords = workHistory.filter(record => record.date === today);
                const todayTotal = todayRecords.reduce((sum, record) => sum + parseFloat(record.duration), 0);

                // Wenn aktuell gearbeitet wird, live hinzufügen
                if (isWorking && workStartTime) {
                    const now = new Date();
                    const ongoing = (now - workStartTime) / (1000 * 60 * 60);
                    todayHours.textContent = (todayTotal + ongoing).toFixed(2) + ' h';
                } else {
                    todayHours.textContent = todayTotal.toFixed(2) + ' h';
                }

                // Wöchentliche Arbeitszeit berechnen
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const weekRecords = workHistory.filter(record => {
                    const recordDate = parseDEDateString(record.date);
                    return recordDate >= oneWeekAgo;
                });

                const weekTotal = weekRecords.reduce((sum, record) => sum + parseFloat(record.duration), 0);
                weekHours.textContent = weekTotal.toFixed(2) + ' h';

                // Monatliche Gesamtzeit berechnen (aktueller Monat)
                const now = new Date();
                const thisYear = now.getFullYear();
                const thisMonth = now.getMonth(); // 0-basiert

                const monthRecords = workHistory.filter(record => {
                    const rd = parseDEDateString(record.date);
                    return rd.getFullYear() === thisYear && rd.getMonth() === thisMonth;
                });
                const monthTotal = monthRecords.reduce((sum, record) => sum + parseFloat(record.duration), 0);
                monthHours.textContent = monthTotal.toFixed(2) + ' h';

                // Monatsziel: wählbare Methode
                let target = 0;
                if (targetMethodSelect.value === 'wochenformel') {
                    // Wochenformel: Wochenstunden * (13/3) approximiert Wochen pro Monat (~4.3333)
                    const weekly = parseFloat(weeklyHoursInput.value) || 40;
                    target = weekly * (13 / 3);
                } else {
                    const workingDays = countWeekdaysInMonth(thisYear, thisMonth);
                    target = workingDays * dailyWorkHours;
                }
                monthTarget.textContent = target.toFixed(2) + ' h';
            }

            function updateHistory() {
                historyBody.innerHTML = '';

                // Letzte 10 Einträge anzeigen
                const recentHistory = workHistory.slice(-10).reverse();

                recentHistory.forEach(record => {
                    const row = document.createElement('tr');

                    const dateCell = document.createElement('td');
                    dateCell.textContent = record.date;

                    const startCell = document.createElement('td');
                    startCell.textContent = record.startTime || '-';

                    const endCell = document.createElement('td');
                    endCell.textContent = record.endTime || '-';

                    const durationCell = document.createElement('td');
                    durationCell.textContent = record.duration + ' h';

                    row.appendChild(dateCell);
                    row.appendChild(startCell);
                    row.appendChild(endCell);
                    row.appendChild(durationCell);

                    historyBody.appendChild(row);
                });
            }

            // Manuellen Eintrag hinzufügen
            addEntryBtn.addEventListener('click', function() {
                let dateValue = entryDate.value;
                const hoursValue = parseFloat(entryHours.value);
                // Wenn keine Pause angegeben wurde, verwende den Default (automatisch 45 min)
                const breakMinutes = entryBreak.value === '' ? defaultBreakMinutes : parseInt(entryBreak.value || '0', 10);

                if (!dateValue) {
                    const d = new Date();
                    // date input liefert yyyy-mm-dd; wir bleiben bei dieser Form
                    dateValue = d.toISOString().slice(0,10);
                }

                if (isNaN(hoursValue) || hoursValue <= 0) {
                    alert('Bitte gültige Stunden eingeben.');
                    return;
                }

                // dateValue ist yyyy-mm-dd -> in dd.mm.yyyy umwandeln
                const parts = dateValue.split('-');
                const formatted = `${parts[2]}.${parts[1]}.${parts[0]}`;

                const duration = Math.max(0, hoursValue - (breakMinutes / 60));

                const record = {
                    date: formatted,
                    startTime: '-',
                    endTime: '-',
                    duration: duration.toFixed(2)
                };

                workHistory.push(record);
                localStorage.setItem('workHistory', JSON.stringify(workHistory));

                // Inputs zurücksetzen
                entryDate.value = '';
                entryHours.value = '';
                entryBreak.value = '';

                updateHistory();
                updateSummary();
            });

            // Einstellungen: persistieren und neu berechnen
            function saveSettings() {
                localStorage.setItem('targetMethod', targetMethodSelect.value);
                localStorage.setItem('weeklyHours', parseFloat(weeklyHoursInput.value) || 40);
            }

            targetMethodSelect.addEventListener('change', function() {
                saveSettings();
                updateSummary();
            });

            weeklyHoursInput.addEventListener('input', function() {
                saveSettings();
                updateSummary();
            });

            // Event Listeners
            startBtn.addEventListener('click', startWorkTimer);
            stopBtn.addEventListener('click', stopWorkTimer);

            // Initialisierung
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            updateHistory();
            updateSummary();

            // Prüfen, ob bereits eine Arbeitszeit aktiv ist (nach Seitenrefresh)
            const activeWork = localStorage.getItem('activeWork');
            if (activeWork) {
                workStartTime = new Date(activeWork);
                isWorking = true;
                statusText.textContent = `Arbeit läuft seit ${workStartTime.toLocaleTimeString('de-DE')}`;
                statusCard.classList.add('status-working');
                startBtn.disabled = true;
                stopBtn.disabled = false;
                workInterval = setInterval(updateWorkTime, 1000);
                updateSummary();
            }
        });
    </script>
</body>
</html>